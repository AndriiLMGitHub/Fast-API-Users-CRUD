# pythonanywhere_setup.py
#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è FastAPI –Ω–∞ PythonAnywhere
"""
import os
import sys
import subprocess
import shutil

def run_command(command):
    """–í–∏–∫–æ–Ω–∞—Ç–∏ –∫–æ–º–∞–Ω–¥—É —Ç–∞ –ø–æ–∫–∞–∑–∞—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç"""
    print(f"–í–∏–∫–æ–Ω—É—é: {command}")
    result = subprocess.run(command, shell=True, capture_output=True, text=True)
    if result.returncode != 0:
        print(f"–ü–æ–º–∏–ª–∫–∞: {result.stderr}")
        return False
    print(f"–£—Å–ø—ñ—à–Ω–æ: {result.stdout}")
    return True

def setup_pythonanywhere():
    """–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø—Ä–æ–µ–∫—Ç—É –¥–ª—è PythonAnywhere"""

    # –û—Ç—Ä–∏–º—É—î–º–æ username
    username = input("–í–≤–µ–¥—ñ—Ç—å –≤–∞—à PythonAnywhere username: ")

    # –®–ª—è—Ö–∏
    home_dir = f"/home/{username}"
    project_dir = f"{home_dir}/my-fastapi-app"
    venv_dir = f"{project_dir}/venv"

    print(f"–ù–∞–ª–∞—à—Ç–æ–≤—É—é –ø—Ä–æ–µ–∫—Ç –≤ {project_dir}")

    # –°—Ç–≤–æ—Ä—é—î–º–æ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ
    if not os.path.exists(venv_dir):
        print("–°—Ç–≤–æ—Ä—é—é –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ...")
        run_command(f"python3.10 -m venv {venv_dir}")

    # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
    print("–í—Å—Ç–∞–Ω–æ–≤–ª—é—é –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ...")
    pip_path = f"{venv_dir}/bin/pip"
    run_command(f"{pip_path} install --upgrade pip")
    run_command(f"{pip_path} install -r requirements.txt")

    # –°—Ç–≤–æ—Ä—é—î–º–æ WSGI —Ñ–∞–π–ª
    wsgi_content = f'''
import os
import sys

path = '{project_dir}'
if path not in sys.path:
    sys.path.insert(0, path)

from main import app
from asgiref.wsgi import WsgiToAsgi

application = WsgiToAsgi(app)
'''

    wsgi_path = f"/var/www/{username}_pythonanywhere_com_wsgi.py"
    try:
        with open(wsgi_path, 'w') as f:
            f.write(wsgi_content)
        print(f"WSGI —Ñ–∞–π–ª —Å—Ç–≤–æ—Ä–µ–Ω–æ: {wsgi_path}")
    except PermissionError:
        print(f"–ù–µ –≤–¥–∞–ª–æ—Å—è —Å—Ç–≤–æ—Ä–∏—Ç–∏ WSGI —Ñ–∞–π–ª. –°—Ç–≤–æ—Ä—ñ—Ç—å –π–æ–≥–æ –≤—Ä—É—á–Ω—É –≤ Web tab.")

    # –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –±–∞–∑—É –¥–∞–Ω–∏—Ö
    print("–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—é –±–∞–∑—É –¥–∞–Ω–∏—Ö...")
    python_path = f"{venv_dir}/bin/python"
    run_command(f"cd {project_dir} && {python_path} -c 'from src.db.init_db import init_db; import asyncio; asyncio.run(init_db())'")

    print("\n‚úÖ –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ!")
    print("\nüìã –ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏:")
    print("1. –ü–µ—Ä–µ–π–¥—ñ—Ç—å –≤ Web tab –Ω–∞ PythonAnywhere")
    print("2. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å 'Reload' –¥–ª—è –≤–∞—à–æ–≥–æ web app")
    print(f"3. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ WSGI —Ñ–∞–π–ª: {wsgi_path}")
    print(f"4. –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å Virtualenv: {venv_dir}")
    print("5. –î–æ–¥–∞–π—Ç–µ Static files —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ")

if __name__ == "__main__":
    setup_pythonanywhere()